---
title: "Data Cleaning"
author: "Your Name"
date: today
format:
  html:
    code-fold: false
    toc: true
---

# Introduction

Now I'll clean the data to prepare it for analysis.

## Main Cleaning Script

```{r}
#| label: full-cleaning-process
#| message: false
#| warning: false

# 1. Load Libraries
library(tidyverse)
library(lubridate)
library(knitr)

# 2. Load Raw Data
# Ensure this path matches where your import script saved the file
earthquake_raw <- readRDS("../data/processed/earthquake_raw.rds")

# 3. Process the Data
earthquake <- earthquake_raw %>%
  # Remove empty columns
  select(-starts_with("Empty")) %>%
  
  # Convert Data Types & Fix Intensity
  mutate(
    # Convert time parts to integers
    Year = as.integer(Year),
    Month = as.integer(Month),
    Day = as.integer(Day),
    Hour = as.integer(Hour),
    Minute = as.integer(Minute),
    Second = as.integer(Second),
    
    # Convert measurements to numeric
    Magnitude = as.numeric(Magnitude),
    Epicenter_Lat = as.numeric(Epicenter_Lat),
    Epicenter_Lon = as.numeric(Epicenter_Lon),
    Distance_km = as.numeric(Distance_km),
    
    # FIX: Handle Roman Numerals (IV, V) and numbers simultaneously
    Intensity = case_when(
      Intensity == "I" ~ 1,
      Intensity == "II" ~ 2,
      Intensity == "III" ~ 3,
      Intensity == "IV" ~ 4,
      Intensity == "V" ~ 5,
      Intensity == "VI" ~ 6,
      Intensity == "VII" ~ 7,
      Intensity == "VIII" ~ 8,
      Intensity == "IX" ~ 9,
      Intensity == "X" ~ 10,
      TRUE ~ as.numeric(as.character(Intensity)) # Handle standard numbers
    )
  ) %>%
  
  # Create DateTime
  mutate(
    DateTime = make_datetime(Year, Month, Day, Hour, Minute, Second)
  ) %>%
  
  # Remove invalid rows (missing coordinates)
  filter(!is.na(Epicenter_Lat) & !is.na(Epicenter_Lon)) %>%

  # SCIENTIFIC FILTER (Fixes Correlation Issue)
  # Isolate 1983 events and ensure valid physics values
  filter(
    Year == 1983,           # Focus on the specific event year
    Magnitude > 0,          # Remove invalid magnitudes
    Distance_km >= 0        # Remove invalid distances
  ) %>%

  # Add Categories
  mutate(
    Distance_Category = case_when(
      Distance_km < 50 ~ "Near",
      Distance_km < 100 ~ "Medium",
      Distance_km < 150 ~ "Far",
      TRUE ~ "Very Far"
    )
  )

# 4. Save the Clean Data
saveRDS(earthquake, "../data/processed/earthquake_clean.rds")
write_csv(earthquake, "../data/processed/earthquake_clean.csv")

# 5. Output Success Message
cat("=== Data Cleaning Complete ===\n")
cat("Total clean observations:", nrow(earthquake), "\n")
cat("Year isolated:", unique(earthquake$Year), "\n")
cat("Data saved to: ../data/processed/earthquake_clean.rds\n")