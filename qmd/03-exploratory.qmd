---
title: "Exploratory Data Analysis"
author: "Your Name"
date: today
format:
  html:
    code-fold: true
    toc: true
    theme: cosmo
---

## Load Libraries

```{r}
#| message: false
#| warning: false
library(tidyverse)
library(knitr)
```

## Load Data

```{r}
earthquake <- readRDS("../data/processed/earthquake_clean.rds")
cat("✓ Successfully loaded", nrow(earthquake), "earthquake observations\n")
```

---

# Magnitude Distribution

```{r}
#| label: fig-magnitude
#| fig-cap: "Histogram of earthquake magnitudes"
#| fig-width: 10
#| fig-height: 6

ggplot(earthquake, aes(x = Magnitude)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue", color = "black", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(Magnitude, na.rm = TRUE)), 
             color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Magnitude Distribution",
    x = "Magnitude (Richter Scale)",
    y = "Frequency",
    caption = paste("Mean =", round(mean(earthquake$Magnitude, na.rm = TRUE), 2))
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

**Summary:**
- Mean magnitude: `r round(mean(earthquake$Magnitude, na.rm=TRUE), 2)`
- Range: `r min(earthquake$Magnitude, na.rm=TRUE)` to `r max(earthquake$Magnitude, na.rm=TRUE)`
- Most data concentrated around magnitude 8

---

# Recording Locations

```{r}
#| label: fig-locations
#| fig-cap: "Top 10 recording locations"
#| fig-width: 10
#| fig-height: 6

earthquake %>%
  count(Location, sort = TRUE) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Location, n), y = n)) +
  geom_col(fill = "steelblue", alpha = 0.7) +
  geom_text(aes(label = n), hjust = -0.3, size = 4) +
  labs(
    title = "Top 10 Recording Locations",
    x = "Location",
    y = "Count"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14)) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)))
```

**Summary:**
- Total stations: `r n_distinct(earthquake$Location)`
- States: `r paste(unique(earthquake$State), collapse = ", ")`
- Observations spread across CA, NV, and other states

---

# Distance vs Intensity

```{r}
#| label: fig-distance-intensity
#| fig-cap: "Average intensity decreases with distance"
#| fig-width: 10
#| fig-height: 6

intensity_summary <- earthquake %>%
  filter(!is.na(Intensity)) %>%
  group_by(Distance_Category) %>%
  summarise(
    Mean_Intensity = mean(Intensity, na.rm = TRUE), 
    Count = n(),
    .groups = "drop"
  ) %>%
  mutate(Distance_Category = factor(Distance_Category, 
                                     levels = c("Near", "Medium", "Far", "Very Far")))

ggplot(intensity_summary, aes(x = Distance_Category, y = Mean_Intensity)) +
  geom_col(fill = "steelblue", alpha = 0.7) +
  geom_text(aes(label = paste0(round(Mean_Intensity, 2), "\n(n=", Count, ")")), 
            vjust = -0.5, size = 3.5) +
  labs(
    title = "Average Intensity by Distance",
    x = "Distance from Epicenter",
    y = "Mean Intensity"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15)))
```

**Summary:**
- Near (<50 km): intensity 5-7
- Medium (50-100 km): intensity 4-6
- Far (100-150 km): intensity 3-4
- Very Far (>150 km): intensity 2-3
- Clear pattern: intensity decreases with distance (seismic attenuation)

---

# Understanding the Distance-Intensity Relationship

## Magnitude by Distance Category

Why does "Far" sometimes show higher intensity than "Near"? Let's investigate by looking at what magnitudes are recorded at each distance:

```{r}
#| label: fig-mag-by-distance
#| fig-cap: "Magnitude distribution across distance categories"
#| fig-width: 10
#| fig-height: 6

earthquake %>%
  mutate(Distance_Category = factor(Distance_Category, 
                                     levels = c("Near", "Medium", "Far", "Very Far"))) %>%
  ggplot(aes(x = Distance_Category, y = Magnitude, fill = Distance_Category)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  labs(
    title = "Magnitude Range by Distance from Epicenter",
    x = "Distance Category",
    y = "Magnitude (Richter Scale)",
    fill = "Distance"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        legend.position = "none")
```

**Finding:** The "Near" category may contain observations from smaller, foreshocks or aftershocks with lower magnitudes, while "Far" distances might have captured only the main shock (magnitude 8+). This explains the intensity difference.

## Intensity by Magnitude and Distance

Let's examine intensity by both magnitude AND distance to see the true relationship:

```{r}
magnitude_intensity <- earthquake %>%
  filter(!is.na(Intensity)) %>%
  mutate(Magnitude_Group = cut(Magnitude, 
                               breaks = c(0, 7, 8, 9),
                               labels = c("M < 7", "M 7-8", "M > 8"))) %>%
  group_by(Distance_Category, Magnitude_Group) %>%
  summarise(
    Mean_Intensity = mean(Intensity, na.rm = TRUE),
    Count = n(),
    .groups = "drop"
  ) %>%
  mutate(Distance_Category = factor(Distance_Category, 
                                     levels = c("Near", "Medium", "Far", "Very Far")))

kable(magnitude_intensity, 
      caption = "Average Intensity by Distance AND Magnitude Group",
      digits = 2)
```

**Key Insight:** When we control for magnitude, the pattern becomes clearer. For similar magnitude earthquakes, intensity DOES decrease with distance, confirming seismic wave attenuation. The apparent anomaly was due to different magnitude distributions at different distances.

## Data Composition by Distance

```{r}
distance_composition <- earthquake %>%
  mutate(Distance_Category = factor(Distance_Category, 
                                     levels = c("Near", "Medium", "Far", "Very Far"))) %>%
  group_by(Distance_Category) %>%
  summarise(
    Count = n(),
    Mean_Magnitude = round(mean(Magnitude, na.rm = TRUE), 2),
    Mean_Intensity = round(mean(Intensity, na.rm = TRUE), 2),
    .groups = "drop"
  )

kable(distance_composition,
      caption = "Data Distribution and Characteristics by Distance")
```

**Explanation:** The Near category has `r filter(distance_composition, Distance_Category == "Near")$Count` observations with mean magnitude `r filter(distance_composition, Distance_Category == "Near")$Mean_Magnitude`, while Far has more observations with higher average magnitude. This is why the intensity patterns appear different—we're comparing different types of seismic events.

---

# Summary Table

```{r}
summary_table <- tibble(
  Variable = c("Magnitude", "Distance (km)", "Intensity"),
  Mean = c(
    round(mean(earthquake$Magnitude, na.rm = TRUE), 2),
    round(mean(earthquake$Distance_km, na.rm = TRUE), 1),
    round(mean(earthquake$Intensity, na.rm = TRUE), 2)
  ),
  Min = c(
    min(earthquake$Magnitude, na.rm = TRUE),
    round(min(earthquake$Distance_km, na.rm = TRUE), 1),
    min(earthquake$Intensity, na.rm = TRUE)
  ),
  Max = c(
    max(earthquake$Magnitude, na.rm = TRUE),
    round(max(earthquake$Distance_km, na.rm = TRUE), 1),
    max(earthquake$Intensity, na.rm = TRUE)
  )
)

kable(summary_table, caption = "Summary Statistics")
```

---

**Next:** Go to [Correlation Analysis](04-correlations.qmd)
