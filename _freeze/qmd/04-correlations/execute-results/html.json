{
  "hash": "39af978e04714f51b082093bc270da5c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Correlation Analysis\"\nauthor: \"Your Name\"\ndate: today\nformat:\n  html:\n    code-fold: false\n    toc: true\n---\n\n# Introduction\n\nCorrelation analysis helps us understand **relationships between variables** in seismic data for the 1983 earthquake event. By focusing on a single event, we eliminate the confounding effect of mixing different magnitude earthquakes.\n\n## Load Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'tidyverse' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'ggplot2' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'tibble' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'tidyr' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'readr' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'purrr' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'dplyr' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'stringr' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'forcats' was built under R version 4.5.2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'lubridate' was built under R version 4.5.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(corrplot)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'corrplot' was built under R version 4.5.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(knitr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'knitr' was built under R version 4.5.2\n```\n\n\n:::\n:::\n\n\n## Load Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nearthquake <- readRDS(\"../data/processed/earthquake_clean.rds\")\ncat(\"âœ“ Loaded\", nrow(earthquake), \"observations\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nâœ“ Loaded 142083 observations\n```\n\n\n:::\n:::\n\n\n## Diagnostic: Check Data Quality\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check the full dataset first\ncat(\"\\n=== FULL DATASET DIAGNOSTICS ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== FULL DATASET DIAGNOSTICS ===\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Total observations:\", nrow(earthquake), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTotal observations: 142083 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Magnitude range:\", min(earthquake$Magnitude, na.rm = TRUE), \"to\", \n    max(earthquake$Magnitude, na.rm = TRUE), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMagnitude range: 4 to 11 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Magnitude variance:\", round(var(earthquake$Magnitude, na.rm = TRUE), 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMagnitude variance: 1.75 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Non-NA Intensity values:\", sum(!is.na(earthquake$Intensity)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNon-NA Intensity values: 116500 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Intensity range:\", min(earthquake$Intensity, na.rm = TRUE), \"to\", \n    max(earthquake$Intensity, na.rm = TRUE), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nIntensity range: 1 to 12 \n```\n\n\n:::\n:::\n\n\n## Filter for 1983 Event\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filter for 1983 event only\nearthquake_1983 <- earthquake %>%\n  mutate(Year = format(DateTime, \"%Y\")) %>%\n  filter(Year == \"1983\")\n\ncat(\"\\n=== 1983 EVENT DIAGNOSTICS ===\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== 1983 EVENT DIAGNOSTICS ===\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"Filtered to 1983 event:\", nrow(earthquake_1983), \"observations\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFiltered to 1983 event: 6938 observations\n```\n\n\n:::\n\n```{.r .cell-code}\nif(nrow(earthquake_1983) == 0) {\n  stop(\"No data found for 1983. Please check your dataset.\")\n}\n\n# Check magnitude variation in 1983\ncat(\"\\nMagnitude statistics for 1983:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nMagnitude statistics for 1983:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Range:\", min(earthquake_1983$Magnitude, na.rm = TRUE), \"to\", \n    max(earthquake_1983$Magnitude, na.rm = TRUE), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Range: 5 to 11 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Mean:\", round(mean(earthquake_1983$Magnitude, na.rm = TRUE), 2), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Mean: 6.63 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Variance:\", round(var(earthquake_1983$Magnitude, na.rm = TRUE), 4), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Variance: 2.5893 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Check intensity data\ncat(\"\\nIntensity statistics for 1983:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nIntensity statistics for 1983:\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Non-NA values:\", sum(!is.na(earthquake_1983$Intensity)), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Non-NA values: 6938 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  Range:\", min(earthquake_1983$Intensity, na.rm = TRUE), \"to\", \n    max(earthquake_1983$Intensity, na.rm = TRUE), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Range: 2 to 8 \n```\n\n\n:::\n\n```{.r .cell-code}\n# WARNING if magnitude has no variation\nif(var(earthquake_1983$Magnitude, na.rm = TRUE) < 0.01) {\n  cat(\"\\nâš ï¸ WARNING: Magnitude has very little variation in 1983!\\n\")\n  cat(\"   This is expected for a single earthquake event.\\n\")\n  cat(\"   Magnitude-Intensity correlation will be weak/undefined.\\n\")\n  cat(\"   ðŸ’¡ Solution: Use the FULL dataset for Magnitude-Intensity correlation.\\n\")\n}\n```\n:::\n\n\n---\n\n# Correlation Matrix for 1983 Event\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnumeric_data <- earthquake_1983 %>%\n  select(Magnitude, Distance_km, Intensity, Epicenter_Lat, Epicenter_Lon) %>%\n  na.omit()\n\nif(nrow(numeric_data) > 10) {\n  cor_matrix <- cor(numeric_data)\n  \n  corrplot(cor_matrix,\n           method = \"circle\",\n           type = \"upper\",\n           tl.col = \"black\",\n           addCoef.col = \"black\",\n           number.cex = 0.8,\n           col = colorRampPalette(c(\"#6D9EC1\", \"white\", \"#E46726\"))(200),\n           title = \"Correlation Matrix (1983 Event)\",\n           mar = c(0, 0, 2, 0))\n  \n  cat(\"\\nâœ“ Correlation matrix generated with\", nrow(numeric_data), \"complete observations\\n\")\n} else {\n  stop(\"Not enough data for 1983 event. Need at least 10 complete observations.\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nâœ“ Correlation matrix generated with 6899 complete observations\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Correlation matrix for the 1983 earthquake event](04-correlations_files/figure-html/fig-corrplot-1.png){#fig-corrplot width=864}\n:::\n:::\n\n\n::: {.callout-note}\n## Reading the Matrix\n- **Red circles** = Positive correlation (variables increase together)\n- **Blue circles** = Negative correlation (one increases, other decreases)\n- **Circle size** = Strength of correlation\n- **Numbers** = Correlation coefficients (-1 to +1)\n\nBy analyzing a single earthquake event (1983), we eliminate the confounding effect where different magnitude earthquakes mask the true physical relationships.\n:::\n\n---\n\n# Key Relationships\n\n## Magnitude vs Distance\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(earthquake_1983, aes(x = Distance_km, y = Magnitude)) +\n  geom_point(alpha = 0.5, color = \"darkblue\", size = 2.5) +\n  geom_smooth(method = \"lm\", color = \"red\", linewidth = 1.2, se = TRUE) +\n  labs(\n    title = \"Magnitude vs Distance (1983 Event)\",\n    x = \"Distance (km)\",\n    y = \"Magnitude\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 39 rows containing non-finite outside the scale range\n(`stat_smooth()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 39 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n```{.r .cell-code}\ncor_test <- cor.test(earthquake_1983$Magnitude, earthquake_1983$Distance_km)\ncat(\"\\nCorrelation coefficient:\", round(cor_test$estimate, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCorrelation coefficient: -0.26 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"P-value:\", format.pval(cor_test$p.value), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP-value: < 2.22e-16 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (cor_test$p.value < 0.05) {\n  cat(\"âœ“ Statistically significant relationship (p < 0.05)\\n\")\n} else {\n  cat(\"No statistically significant relationship (p â‰¥ 0.05)\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nâœ“ Statistically significant relationship (p < 0.05)\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Relationship between earthquake magnitude and distance (1983 event)](04-correlations_files/figure-html/fig-mag-distance-1.png){#fig-mag-distance width=960}\n:::\n:::\n\n\n---\n\n## Magnitude vs Intensity\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check if we should use full dataset or 1983\nuse_full_dataset <- var(earthquake_1983$Magnitude, na.rm = TRUE) < 0.01\n\nif(use_full_dataset) {\n  cat(\"ðŸ“Š Using FULL DATASET for Magnitude-Intensity correlation\\n\")\n  cat(\"   (1983 has insufficient magnitude variation)\\n\\n\")\n  \n  plot_data <- earthquake %>% filter(!is.na(Intensity))\n  \n  p <- ggplot(plot_data, aes(x = Magnitude, y = Intensity)) +\n    geom_point(alpha = 0.5, color = \"darkgreen\", size = 2.5) +\n    geom_smooth(method = \"lm\", color = \"red\", linewidth = 1.2, se = TRUE) +\n    labs(\n      title = \"Magnitude vs Intensity (All Events)\",\n      subtitle = \"Using full dataset to capture magnitude variation across different earthquakes\",\n      x = \"Magnitude\",\n      y = \"Intensity\"\n    ) +\n    theme_minimal()\n  \n  print(p)\n  \n  intensity_data_mag <- plot_data\n  cor_test2 <- cor.test(plot_data$Magnitude, plot_data$Intensity)\n  \n} else {\n  cat(\"ðŸ“Š Using 1983 EVENT for Magnitude-Intensity correlation\\n\\n\")\n  \n  plot_data <- earthquake_1983 %>% filter(!is.na(Intensity))\n  \n  p <- ggplot(plot_data, aes(x = Magnitude, y = Intensity)) +\n    geom_point(alpha = 0.5, color = \"darkgreen\", size = 2.5) +\n    geom_smooth(method = \"lm\", color = \"red\", linewidth = 1.2, se = TRUE) +\n    labs(\n      title = \"Magnitude vs Intensity (1983 Event)\",\n      x = \"Magnitude\",\n      y = \"Intensity\"\n    ) +\n    theme_minimal()\n  \n  print(p)\n  \n  intensity_data_mag <- plot_data\n  cor_test2 <- cor.test(plot_data$Magnitude, plot_data$Intensity)\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nðŸ“Š Using 1983 EVENT for Magnitude-Intensity correlation\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nCorrelation coefficient:\", round(cor_test2$estimate, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCorrelation coefficient: -0.104 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"P-value:\", format.pval(cor_test2$p.value), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP-value: < 2.22e-16 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (cor_test2$p.value < 0.05) {\n  cat(\"âœ“ Statistically significant relationship (p < 0.05)\\n\")\n} else {\n  cat(\"No statistically significant relationship (p â‰¥ 0.05)\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nâœ“ Statistically significant relationship (p < 0.05)\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Relationship between earthquake magnitude and observed intensity](04-correlations_files/figure-html/fig-mag-intensity-1.png){#fig-mag-intensity width=960}\n:::\n:::\n\n\n::: {.callout-note}\n## Understanding Magnitude-Intensity Correlation\n\n**Why is this correlation weak for a single event?**\n- In a single earthquake, all observations come from the same seismic event\n- Magnitude is essentially constant (e.g., all readings ~6.0)\n- **You can't correlate two variables if one doesn't vary!**\n\n**The Solution:**\n- For **Magnitude â†” Intensity**: Use the full dataset (multiple earthquakes with different magnitudes)\n- For **Distance â†” Intensity**: Use single event (1983) to eliminate confounding\n\nThis approach gives us the best of both worlds: true physical relationships without confounding variables.\n:::\n\n---\n\n## Distance vs Intensity\n\n\n::: {.cell}\n\n```{.r .cell-code}\nintensity_data <- earthquake_1983 %>% filter(!is.na(Intensity))\n\nearthquake_1983 %>%\n  filter(!is.na(Intensity)) %>%\n  ggplot(aes(x = Distance_km, y = Intensity)) +\n  geom_point(aes(color = Magnitude), alpha = 0.6, size = 2.5) + \n  geom_smooth(method = \"lm\", color = \"black\", linewidth = 1.2, se = TRUE) +\n  scale_color_gradient(low = \"blue\", high = \"red\", name = \"Magnitude\") +\n  labs(\n    title = \"Attenuation of Intensity with Distance (1983 Event)\",\n    subtitle = \"Single event analysis reveals true physical decay of seismic waves\",\n    x = \"Distance (km)\",\n    y = \"Intensity (MMI)\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 39 rows containing non-finite outside the scale range\n(`stat_smooth()`).\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 39 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n```{.r .cell-code}\ncor_test3 <- cor.test(intensity_data$Distance_km, intensity_data$Intensity)\ncat(\"\\nCorrelation coefficient:\", round(cor_test3$estimate, 3), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCorrelation coefficient: -0.044 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"P-value:\", format.pval(cor_test3$p.value), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nP-value: 0.00025307 \n```\n\n\n:::\n\n```{.r .cell-code}\nif (cor_test3$p.value < 0.05) {\n  cat(\"âœ“ Statistically significant relationship (p < 0.05)\\n\")\n  if(cor_test3$estimate < 0) {\n    cat(\"âœ“ Negative correlation confirms seismic attenuation: intensity decreases with distance\\n\")\n  }\n} else {\n  cat(\"No statistically significant relationship (p â‰¥ 0.05)\\n\")\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nâœ“ Statistically significant relationship (p < 0.05)\nâœ“ Negative correlation confirms seismic attenuation: intensity decreases with distance\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Distance vs Intensity showing seismic attenuation (1983 event)](04-correlations_files/figure-html/fig-distance-intensity-1.png){#fig-distance-intensity width=960}\n:::\n:::\n\n\n::: {.callout-tip}\n## Why Focus on a Single Event for Distance-Intensity?\n\nBy analyzing only the 1983 earthquake, we control for magnitude variations. This reveals the true physical relationship: **seismic intensity decreases with distance from the epicenter** (attenuation), which would be masked if we mixed earthquakes of different energy levels.\n:::\n\n---\n\n# Summary\n\n\n::: {#tbl-summary .cell tbl-cap='Summary of correlation findings'}\n\n```{.r .cell-code}\ntibble(\n  Relationship = c(\"Magnitude â†” Distance (1983)\", \n                   \"Magnitude â†” Intensity (All Events)\", \n                   \"Distance â†” Intensity (1983)\"),\n  Correlation = c(\n    round(cor(earthquake_1983$Magnitude, earthquake_1983$Distance_km, use = \"complete.obs\"), 3),\n    round(cor(intensity_data_mag$Magnitude, intensity_data_mag$Intensity, use = \"complete.obs\"), 3),\n    round(cor(intensity_data$Distance_km, intensity_data$Intensity, use = \"complete.obs\"), 3)\n  ),\n  Strength = c(\n    case_when(\n      abs(cor(earthquake_1983$Magnitude, earthquake_1983$Distance_km, use = \"complete.obs\")) > 0.7 ~ \"Strong\",\n      abs(cor(earthquake_1983$Magnitude, earthquake_1983$Distance_km, use = \"complete.obs\")) > 0.4 ~ \"Moderate\",\n      TRUE ~ \"Weak\"\n    ),\n    case_when(\n      abs(cor(intensity_data_mag$Magnitude, intensity_data_mag$Intensity, use = \"complete.obs\")) > 0.7 ~ \"Strong\",\n      abs(cor(intensity_data_mag$Magnitude, intensity_data_mag$Intensity, use = \"complete.obs\")) > 0.4 ~ \"Moderate\",\n      TRUE ~ \"Weak\"\n    ),\n    case_when(\n      abs(cor(intensity_data$Distance_km, intensity_data$Intensity, use = \"complete.obs\")) > 0.7 ~ \"Strong\",\n      abs(cor(intensity_data$Distance_km, intensity_data$Intensity, use = \"complete.obs\")) > 0.4 ~ \"Moderate\",\n      TRUE ~ \"Weak\"\n    )\n  ),\n  `P-value < 0.05` = c(\n    ifelse(cor_test$p.value < 0.05, \"Yes\", \"No\"),\n    ifelse(cor_test2$p.value < 0.05, \"Yes\", \"No\"),\n    ifelse(cor_test3$p.value < 0.05, \"Yes\", \"No\")\n  ),\n  `Data Used` = c(\"1983 only\", \"All events\", \"1983 only\")\n) %>%\n  kable()\n```\n\n::: {.cell-output-display}\n\n\n|Relationship                       | Correlation|Strength |P-value < 0.05 |Data Used  |\n|:----------------------------------|-----------:|:--------|:--------------|:----------|\n|Magnitude â†” Distance (1983)        |      -0.260|Weak     |Yes            |1983 only  |\n|Magnitude â†” Intensity (All Events) |      -0.104|Weak     |Yes            |All events |\n|Distance â†” Intensity (1983)        |      -0.044|Weak     |Yes            |1983 only  |\n\n\n:::\n:::\n\n\n## Key Findings\n\n::: {.callout-important}\n## Correlation Results - Hybrid Approach\n\nThis analysis uses a **strategic hybrid approach** to avoid confounding variables:\n\n1. **Magnitude and Distance (1983 Event)**: \n   - Correlation: -0.26\n   - Single event shows how one earthquake's readings vary with distance\n\n2. **Magnitude and Intensity (All Events)**: \n   - Correlation: -0.104\n   - **Uses full dataset** because we need magnitude variation to see the relationship\n   - Single events have nearly constant magnitude, making correlation impossible\n\n3. **Distance and Intensity (1983 Event)**: \n   - Correlation: -0.044\n   - **Uses single event** to eliminate the confounding effect of different magnitudes\n   - Reveals true seismic attenuation\n\n**Statistical Lesson**: Choose your dataset strategically:\n- Use **single event** when you need to control for magnitude (Distance-Intensity)\n- Use **all events** when you need magnitude variation (Magnitude-Intensity)\n:::\n\n---\n\n**Next:** Go to [Conclusions](07-conclusions.qmd) â†’",
    "supporting": [
      "04-correlations_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}